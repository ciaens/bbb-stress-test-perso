#!/bin/sh
#
# The container user (see USER in the Dockerfile) is an un-privileged user that
# does not exists and is not created during the build phase (see Dockerfile).
# Hence, we use this entrypoint to wrap commands that will be run in the
# container to create an entry for this user in the /etc/passwd file.
#
# The following environment variables may be passed to the container to
# customize running user account:
#
#   * USER_NAME: container user name (default: default)
#   * HOME     : container user home directory (default: none)
#   * DOCKER_USER: user ID to run as (default: 1000)
#
# To pass environment variables, you can either use the -e option of the docker run command:
#
#     docker run --rm -e USER_NAME=foo -e HOME='/home/foo' ashley:latest python manage.py migrate
#
# or define new variables in an environment file to use with docker or docker-compose:
#
#     # env.d/production
#     USER_NAME=foo
#     HOME=/home/foo
#
#     docker run --rm --env-file env.d/production ashley:latest python manage.py migrate
#

# If running as root, fix permissions for volume-mounted files before dropping privileges
if [ "$(id -u)" = "0" ]; then
  echo "ğŸ³(entrypoint) running as root, fixing permissions for volume-mounted files..."

  # Fix cli.js permissions if it exists and is not executable
  if [ -f "/app/cli.js" ] && [ ! -x "/app/cli.js" ]; then
    chmod +x /app/cli.js && echo "ğŸ³(entrypoint) made cli.js executable"
  fi

  # Determine target user
  TARGET_USER="${DOCKER_USER:-1000}"

  echo "ğŸ³(entrypoint) dropping privileges to user ${TARGET_USER}..."

  # Use gosu to drop privileges and re-execute this script
  exec gosu "${TARGET_USER}" "$0" "$@"
fi

# Now running as unprivileged user
echo "ğŸ³(entrypoint) creating user running in the container..."
if ! whoami > /dev/null 2>&1; then
  if [ -w /etc/passwd ]; then
    echo "${USER_NAME:-default}:x:$(id -u):$(id -g):${USER_NAME:-default} user:${HOME}:/sbin/nologin" >> /etc/passwd
  fi
fi

echo "ğŸ³(entrypoint) running your command: ${*}"
exec "$@"
